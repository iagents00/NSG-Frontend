"use client";

import React, { useEffect, useState, useRef } from "react";
import { useAppStore, Message, ChatSession } from "@/store/useAppStore";
import { useUIStore } from "@/store/useUIStore";
// import { CONTEXT, RoleType } from '@/data/context';
import {
    Paperclip,
    Mic,
    ArrowUp,
    Loader2,
    X,
    FileText,
    Layers,
    Scale,
    ChevronDown,
    Clock,
    Zap,
    Menu,
    Plus,
    MessageSquare,
    Trash2,
    Calendar,
    MessageCircle,
} from "lucide-react";
import { v4 as uuidv4 } from "uuid";
import ReactMarkdown from "react-markdown";
import remarkGfm from "remark-gfm";
import rehypeRaw from "rehype-raw";
// Refresh import to clear stale cache
import DynamicIsland from "@/components/layout/DynamicIsland";
import clsx from "clsx";
import BrandAtom from "@/components/ui/BrandAtom";
import NewsAnalysisResult from "./NewsAnalysisResult";
import { AnimatePresence, motion } from "framer-motion";

export interface ChatPayload {
    chatId: string; // UUID v4 generated by the frontend
    userId: string; // ID del usuario autenticado
    field: string; // Contexto: "I Copilot Pro", "I Horizon"
    mode: "pulse" | "compare" | "fusion";
    aiModel?: "openai" | "claude" | "gemini"; // Solo requerido si mode === 'pulse'
    message: string; // El prompt del usuario
    attachments?: Array<{
        // Opcional
        name: string;
        url: string; // URL pública o Base64
        type: string; // 'application/pdf', 'audio/ogg'
    }>;
    isDeep?: boolean;
}

const MessageItem = React.memo(
    ({ msg, selectedModel }: { msg: Message; selectedModel: string }) => {
        // Calculate display content based on global selectedModel
        let displayContent: string = msg.content;
        let isWaiting = false;
        let isComingSoon = false;

        if (msg.role === "assistant") {
            // 1. Variations logic (Prioritize metadata for Fusion/Injected)
            if (msg.metadata?.variations) {
                const vars = msg.metadata.variations;
                let foundVar = false;
                if (selectedModel === "Chat GPT" && vars["Chat GPT"]) {
                    displayContent = vars["Chat GPT"];
                    foundVar = true;
                } else if (
                    selectedModel === "Gemini" &&
                    (vars["Gemini"] || vars["Gemini Pro"])
                ) {
                    displayContent = vars["Gemini"] || vars["Gemini Pro"];
                    foundVar = true;
                } else if (selectedModel === "Claude" && vars["Claude"]) {
                    displayContent = vars["Claude"];
                    foundVar = true;
                } else if (
                    selectedModel === "BS AI" ||
                    selectedModel === "BS Fusion"
                ) {
                    displayContent = msg.content; // Consensus
                    foundVar = true;
                }

                if (!foundVar) {
                    isComingSoon = true;
                    displayContent = "";
                }
            }
            // 2. JSON Parsing fallback (for N8N responses)
            else if (
                typeof msg.content === "string" &&
                msg.content.trim().startsWith("{")
            ) {
                try {
                    const parsed = JSON.parse(msg.content);
                    const modelKey = selectedModel
                        .toLowerCase()
                        .replace(/\s+/g, "");

                    // Production Mapping for AI Models
                    const keyMap: Record<string, string[]> = {
                        chatgpt: [
                            "chatgpt",
                            "openai",
                            "gpt",
                            "openAI_response",
                        ],
                        gemini: ["gemini", "gemini_pro", "gemini_response"],
                        claude: ["claude", "anthropic", "claude_response"],
                        bsai: [
                            "bsai",
                            "bs_ai",
                            "nsgai",
                            "nsg",
                            "internal",
                            "nsg_ai",
                            "fusion",
                            "bs_fusion",
                        ],
                        superbs: [
                            "bs_fusion",
                            "superbs",
                            "nsgai",
                            "nsg",
                            "internal",
                            "nsg_ai",
                            "fusion",
                        ],
                    };

                    const targetKeys = keyMap[modelKey] || [modelKey];
                    let rawResult: any = null;

                    // 1. PRIMARY PATH: parsed.answer[modelKey]
                    if (parsed.answer) {
                        if (typeof parsed.answer === "object") {
                            // Find the first matching key for the selected model
                            for (const k of targetKeys) {
                                if (parsed.answer[k]) {
                                    rawResult = parsed.answer[k];
                                    break;
                                }
                            }
                            // Fallback if no model key found but answer is a string-like object
                            if (
                                !rawResult &&
                                (parsed.answer.text ||
                                    parsed.answer.output ||
                                    parsed.answer.response)
                            ) {
                                rawResult =
                                    parsed.answer.text ||
                                    parsed.answer.output ||
                                    parsed.answer.response;
                            }
                        } else {
                            // answer is a direct string
                            rawResult = parsed.answer;
                        }
                    }

                    // 2. SECONDARY PATH: Legacy Root Keys
                    if (!rawResult) {
                        for (const k of targetKeys) {
                            if (parsed[k]) {
                                rawResult = parsed[k];
                                break;
                            }
                        }
                    }

                    // 3. FINAL FALLBACK: General standard keys
                    if (!rawResult) {
                        rawResult =
                            parsed.response ||
                            parsed.output ||
                            parsed.text ||
                            parsed.result;
                    }

                    // 4. CLEANUP & TYPE HANDLING
                    if (rawResult) {
                        // Handle potential double-stringified JSON (happens with some LLM outputs)
                        if (
                            typeof rawResult === "string" &&
                            rawResult.trim().startsWith("{")
                        ) {
                            try {
                                const inner = JSON.parse(rawResult);
                                displayContent =
                                    inner.answer ||
                                    inner.response ||
                                    inner.output ||
                                    inner.text ||
                                    rawResult;
                            } catch {
                                displayContent = rawResult;
                            }
                        } else if (typeof rawResult === "object") {
                            // If we still have an object, try one last time to extract a string field
                            displayContent =
                                rawResult.answer ||
                                rawResult.response ||
                                rawResult.text ||
                                JSON.stringify(rawResult);
                        } else {
                            displayContent = String(rawResult);
                        }
                    } else {
                        // Only mark as "Coming Soon" if we specifically expect a model but got a structured response without it
                        const isStructured =
                            parsed.answer && typeof parsed.answer === "object";
                        if (isStructured) {
                            isComingSoon = true;
                            displayContent = "";
                        } else {
                            // Totally unknown format, show raw content as last resort
                            displayContent = msg.content;
                        }
                    }
                } catch (e) {
                    // Not valid JSON, use raw content
                    displayContent = msg.content;
                }
            }

            // Comprehensive Emoji Removal for Professional AI appearance
            if (displayContent) {
                // Remove standard emojis, symbols, and pictographs
                displayContent = displayContent.replace(
                    /[\u{1F300}-\u{1F9FF}\u{1F600}-\u{1F64F}\u{1F680}-\u{1F6FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F1E6}-\u{1F1FF}\u{1F900}-\u{1F9FF}\u{1F018}-\u{1F270}\u{238C}-\u{2454}\u{203C}\u{2049}\u{2122}\u{2139}\u{2194}-\u{2199}\u{21A9}-\u{21AA}\u{231A}-\u{231B}\u{2328}\u{23CF}\u{23E9}-\u{23F3}\u{23F8}-\u{23FA}\u{24C2}\u{25AA}-\u{25AB}\u{25B6}\u{25C0}\u{25FB}-\u{25FE}\u{2600}-\u{2604}\u{260E}\u{2611}\u{2614}-\u{2615}\u{2618}\u{261D}\u{2620}\u{2622}-\u{2623}\u{2626}\u{262A}\u{262E}-\u{262F}\u{2638}-\u{263A}]/gu,
                    "",
                );
            }
        }

        // If content is empty/null and NOT marked as coming soon, assume waiting
        if ((!displayContent || displayContent.length === 0) && !isComingSoon) {
            isWaiting = true;
        }

        return (
            <motion.div
                id={`msg-${msg.id}`}
                initial={{ opacity: 0, y: 10, scale: 0.98 }}
                animate={{ opacity: 1, y: 0, scale: 1 }}
                transition={{ type: "spring", stiffness: 400, damping: 30 }}
                className={clsx(
                    "flex w-full",
                    msg.role === "user" ? "justify-end" : "justify-start",
                )}
            >
                {msg.role === "user" ? (
                    // USER MESSAGE - Apple Pro Blue Bubble
                    <div className="bg-[#007AFF] text-white px-5 py-3 rounded-[20px] rounded-br-[4px] shadow-sm text-[16px] max-w-[85%] leading-relaxed font-normal tracking-wide selection:bg-white/30">
                        {msg.content}
                    </div>
                ) : (
                    // AI MESSAGE - Clean Pro Text
                    <div className="flex gap-4 group w-full max-w-full items-start">
                        {/* Pro Apple Avatar */}
                        {/* Pro Apple Avatar - Swaps to Multicolor when Thinking */}
                        <div className="w-8 h-8 rounded-full flex items-center justify-center shrink-0 mt-0.5 bg-linear-to-b from-white to-slate-50 border border-slate-200/60 shadow-[0_2px_4px_rgba(0,0,0,0.02)]">
                            {/* If waiting/thinking, show the lively multicolor atom. Otherwise standard BrandAtom */}
                            {isWaiting ? (
                                <BrandAtom
                                    className="w-6 h-6"
                                    variant="multicolor"
                                />
                            ) : (
                                <BrandAtom
                                    className="w-5 h-5"
                                    variant="colored"
                                />
                            )}
                        </div>

                        <div className="flex-1 min-w-0">
                            {msg.type === "analysis" ? (
                                <NewsAnalysisResult
                                    tag={msg.metadata?.tag}
                                    roleContext={msg.metadata?.roleContext}
                                />
                            ) : (
                                <div className="text-[16px] text-navy-850 leading-7 font-normal tracking-normal pt-0.5">
                                    {isComingSoon ? (
                                        // COMING SOON STATE (Professional Branding)
                                        <div className="flex items-center gap-3 px-4 py-3 rounded-2xl bg-slate-50/80 border border-slate-200/60 shadow-sm max-w-sm mt-1 animate-fade-in">
                                            <div className="p-2 bg-white rounded-xl border border-slate-100 shadow-[0_2px_8px_rgba(0,0,0,0.04)]">
                                                <Clock className="w-4 h-4 text-slate-400" />
                                            </div>
                                            <div className="flex flex-col gap-0.5">
                                                <span className="text-[13px] font-bold text-slate-700 tracking-tight font-display">
                                                    Próximamente
                                                </span>
                                                <span className="text-[12px] text-slate-500 font-medium">
                                                    Este modelo estará
                                                    disponible pronto.
                                                </span>
                                            </div>
                                        </div>
                                    ) : !isWaiting ? (
                                        <div className="prose prose-slate max-w-none prose-p:text-slate-800 prose-headings:text-slate-900 prose-strong:text-slate-900 prose-a:text-[#007AFF] prose-code:text-[#eb5757] prose-li:text-slate-800 [&>*:first-child]:mt-0">
                                            <ReactMarkdown
                                                remarkPlugins={[remarkGfm]}
                                                rehypePlugins={[rehypeRaw]}
                                                components={{
                                                    h1: ({
                                                        node,
                                                        ...props
                                                    }) => (
                                                        <h1
                                                            className="text-2xl font-bold mt-6 mb-3 tracking-tight"
                                                            {...props}
                                                        />
                                                    ),
                                                    h2: ({
                                                        node,
                                                        ...props
                                                    }) => (
                                                        <h2
                                                            className="text-xl font-bold mt-5 mb-2 tracking-tight"
                                                            {...props}
                                                        />
                                                    ),
                                                    h3: ({
                                                        node,
                                                        ...props
                                                    }) => (
                                                        <h3
                                                            className="text-lg font-semibold mt-4 mb-2"
                                                            {...props}
                                                        />
                                                    ),
                                                    p: ({ node, ...props }) => (
                                                        <p
                                                            className="mb-3 leading-relaxed"
                                                            {...props}
                                                        />
                                                    ),

                                                    ul: ({
                                                        node,
                                                        ...props
                                                    }) => (
                                                        <ul
                                                            className="list-disc pl-5 mb-3 space-y-1"
                                                            {...props}
                                                        />
                                                    ),
                                                    ol: ({
                                                        node,
                                                        ...props
                                                    }) => (
                                                        <ol
                                                            className="list-decimal pl-5 mb-3 space-y-1"
                                                            {...props}
                                                        />
                                                    ),
                                                    li: ({
                                                        node,
                                                        ...props
                                                    }) => (
                                                        <li
                                                            className="pl-1"
                                                            {...props}
                                                        />
                                                    ),
                                                    strong: ({
                                                        node,
                                                        ...props
                                                    }) => (
                                                        <strong
                                                            className="font-bold text-slate-900"
                                                            {...props}
                                                        />
                                                    ),
                                                    em: ({
                                                        node,
                                                        ...props
                                                    }) => (
                                                        <em
                                                            className="italic"
                                                            {...props}
                                                        />
                                                    ),
                                                    code: ({
                                                        node,
                                                        inline,
                                                        className,
                                                        children,
                                                        ...props
                                                    }: React.ComponentPropsWithoutRef<"code"> & {
                                                        inline?: boolean;
                                                        node?: unknown;
                                                    }) => {
                                                        return inline ? (
                                                            <code
                                                                className="bg-slate-100 px-1.5 py-0.5 rounded text-[13px] font-mono text-[#D12F2F] font-medium align-middle"
                                                                {...props}
                                                            >
                                                                {children}
                                                            </code>
                                                        ) : (
                                                            <span className="block bg-[#1C1C1E] rounded-xl p-4 my-4 overflow-x-auto shadow-sm">
                                                                <code
                                                                    className="text-sm font-mono text-white block whitespace-pre"
                                                                    {...props}
                                                                >
                                                                    {children}
                                                                </code>
                                                            </span>
                                                        );
                                                    },
                                                    blockquote: ({
                                                        node,
                                                        ...props
                                                    }) => (
                                                        <blockquote
                                                            className="border-l-[3px] border-slate-300 pl-4 py-1 my-3 text-slate-500 italic"
                                                            {...props}
                                                        />
                                                    ),
                                                    table: ({
                                                        node,
                                                        ...props
                                                    }) => (
                                                        <div className="overflow-x-auto my-4 rounded-lg border border-slate-200">
                                                            <table
                                                                className="min-w-full divide-y divide-slate-200"
                                                                {...props}
                                                            />
                                                        </div>
                                                    ),
                                                    th: ({
                                                        node,
                                                        ...props
                                                    }) => (
                                                        <th
                                                            className="bg-slate-50 px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider"
                                                            {...props}
                                                        />
                                                    ),
                                                    td: ({
                                                        node,
                                                        ...props
                                                    }) => (
                                                        <td
                                                            className="px-4 py-2 whitespace-nowrap text-sm text-slate-600 border-t border-slate-100"
                                                            {...props}
                                                        />
                                                    ),
                                                    div: ({
                                                        node,
                                                        children,
                                                        ...props
                                                    }) => {
                                                        return (
                                                            <div {...props}>
                                                                {React.Children.map(
                                                                    children,
                                                                    (child) => {
                                                                        if (
                                                                            typeof child ===
                                                                            "string"
                                                                        ) {
                                                                            return (
                                                                                <ReactMarkdown
                                                                                    remarkPlugins={[
                                                                                        remarkGfm,
                                                                                    ]}
                                                                                    rehypePlugins={[
                                                                                        rehypeRaw,
                                                                                    ]}
                                                                                    components={{
                                                                                        p: ({
                                                                                            node,
                                                                                            ...props
                                                                                        }) => (
                                                                                            <>
                                                                                                {
                                                                                                    props.children
                                                                                                }
                                                                                            </>
                                                                                        ),
                                                                                        h1: ({
                                                                                            node,
                                                                                            ...props
                                                                                        }) => (
                                                                                            <span
                                                                                                className="block text-2xl font-bold mt-6 mb-3 tracking-tight"
                                                                                                {...props}
                                                                                            />
                                                                                        ),
                                                                                        h2: ({
                                                                                            node,
                                                                                            ...props
                                                                                        }) => (
                                                                                            <span
                                                                                                className="block text-xl font-bold mt-5 mb-2 tracking-tight"
                                                                                                {...props}
                                                                                            />
                                                                                        ),
                                                                                        h3: ({
                                                                                            node,
                                                                                            ...props
                                                                                        }) => (
                                                                                            <span
                                                                                                className="block text-lg font-semibold mt-4 mb-2"
                                                                                                {...props}
                                                                                            />
                                                                                        ),
                                                                                        ul: ({
                                                                                            node,
                                                                                            ...props
                                                                                        }) => (
                                                                                            <span
                                                                                                className="block pl-5 mb-3"
                                                                                                {...props}
                                                                                            />
                                                                                        ),
                                                                                        ol: ({
                                                                                            node,
                                                                                            ...props
                                                                                        }) => (
                                                                                            <span
                                                                                                className="block pl-5 mb-3"
                                                                                                {...props}
                                                                                            />
                                                                                        ),
                                                                                        li: ({
                                                                                            node,
                                                                                            ...props
                                                                                        }) => (
                                                                                            <span
                                                                                                className="block pl-1"
                                                                                                {...props}
                                                                                            />
                                                                                        ),
                                                                                        strong: ({
                                                                                            node,
                                                                                            ...props
                                                                                        }) => (
                                                                                            <strong
                                                                                                className="font-bold text-inherit"
                                                                                                {...props}
                                                                                            />
                                                                                        ),
                                                                                        em: ({
                                                                                            node,
                                                                                            ...props
                                                                                        }) => (
                                                                                            <em
                                                                                                className="italic text-inherit"
                                                                                                {...props}
                                                                                            />
                                                                                        ),
                                                                                        code: ({
                                                                                            node,
                                                                                            ...props
                                                                                        }) => (
                                                                                            <code
                                                                                                className="bg-slate-100 px-1.5 py-0.5 rounded text-[13px] font-mono font-medium"
                                                                                                {...props}
                                                                                            />
                                                                                        ),
                                                                                    }}
                                                                                >
                                                                                    {
                                                                                        child
                                                                                    }
                                                                                </ReactMarkdown>
                                                                            );
                                                                        }
                                                                        return child;
                                                                    },
                                                                )}
                                                            </div>
                                                        );
                                                    },
                                                    span: ({
                                                        node,
                                                        children,
                                                        ...props
                                                    }) => {
                                                        return (
                                                            <span {...props}>
                                                                {React.Children.map(
                                                                    children,
                                                                    (child) => {
                                                                        if (
                                                                            typeof child ===
                                                                            "string"
                                                                        ) {
                                                                            return (
                                                                                <ReactMarkdown
                                                                                    remarkPlugins={[
                                                                                        remarkGfm,
                                                                                    ]}
                                                                                    rehypePlugins={[
                                                                                        rehypeRaw,
                                                                                    ]}
                                                                                    components={{
                                                                                        p: ({
                                                                                            node,
                                                                                            ...props
                                                                                        }) => (
                                                                                            <>
                                                                                                {
                                                                                                    props.children
                                                                                                }
                                                                                            </>
                                                                                        ),
                                                                                        h1: ({
                                                                                            node,
                                                                                            ...props
                                                                                        }) => (
                                                                                            <span
                                                                                                className="block text-2xl font-bold mt-6 mb-3 tracking-tight"
                                                                                                {...props}
                                                                                            />
                                                                                        ),
                                                                                        h2: ({
                                                                                            node,
                                                                                            ...props
                                                                                        }) => (
                                                                                            <span
                                                                                                className="block text-xl font-bold mt-5 mb-2 tracking-tight"
                                                                                                {...props}
                                                                                            />
                                                                                        ),
                                                                                        h3: ({
                                                                                            node,
                                                                                            ...props
                                                                                        }) => (
                                                                                            <span
                                                                                                className="block text-lg font-semibold mt-4 mb-2"
                                                                                                {...props}
                                                                                            />
                                                                                        ),
                                                                                        ul: ({
                                                                                            node,
                                                                                            ...props
                                                                                        }) => (
                                                                                            <span
                                                                                                className="block pl-5 mb-3"
                                                                                                {...props}
                                                                                            />
                                                                                        ),
                                                                                        ol: ({
                                                                                            node,
                                                                                            ...props
                                                                                        }) => (
                                                                                            <span
                                                                                                className="block pl-5 mb-3"
                                                                                                {...props}
                                                                                            />
                                                                                        ),
                                                                                        li: ({
                                                                                            node,
                                                                                            ...props
                                                                                        }) => (
                                                                                            <span
                                                                                                className="block pl-1"
                                                                                                {...props}
                                                                                            />
                                                                                        ),
                                                                                        blockquote:
                                                                                            ({
                                                                                                node,
                                                                                                ...props
                                                                                            }) => (
                                                                                                <span
                                                                                                    className="block border-l-[3px] border-slate-300 pl-4 py-1 my-3 text-slate-500 italic"
                                                                                                    {...props}
                                                                                                />
                                                                                            ),
                                                                                        strong: ({
                                                                                            node,
                                                                                            ...props
                                                                                        }) => (
                                                                                            <strong
                                                                                                className="font-bold text-inherit"
                                                                                                {...props}
                                                                                            />
                                                                                        ),
                                                                                        em: ({
                                                                                            node,
                                                                                            ...props
                                                                                        }) => (
                                                                                            <em
                                                                                                className="italic text-inherit"
                                                                                                {...props}
                                                                                            />
                                                                                        ),
                                                                                        code: ({
                                                                                            node,
                                                                                            ...props
                                                                                        }) => (
                                                                                            <code
                                                                                                className="bg-slate-100 px-1.5 py-0.5 rounded text-[13px] font-mono font-medium"
                                                                                                {...props}
                                                                                            />
                                                                                        ),
                                                                                    }}
                                                                                >
                                                                                    {
                                                                                        child
                                                                                    }
                                                                                </ReactMarkdown>
                                                                            );
                                                                        }
                                                                        return child;
                                                                    },
                                                                )}
                                                            </span>
                                                        );
                                                    },
                                                }}
                                            >
                                                {displayContent || ""}
                                            </ReactMarkdown>
                                        </div>
                                    ) : (
                                        <div className="mt-1 px-1">
                                            <span className="text-[14px] md:text-[15px] font-medium tracking-wide bg-clip-text text-transparent bg-[linear-gradient(to_right,#64748b,#10B981,#0EA5E9,#64748b)] animate-[shimmer_1.5s_linear_infinite] bg-size-[300%_auto] font-display">
                                                Procesamiento Avanzado...
                                            </span>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                )}
            </motion.div>
        );
    },
    (prev, next) => {
        return (
            prev.msg.content === next.msg.content &&
            prev.msg.role === next.msg.role &&
            prev.msg.type === next.msg.type &&
            prev.selectedModel === next.selectedModel
        );
    },
);

MessageItem.displayName = "MessageItem";

export default function ChatInterface() {
    // 1. GLOBAL STATE
    const { currentRole, isContextCached, setContextCached, userId } =
        useAppStore();

    // 2. LOCAL STATE
    const [cacheName, setCacheName] = useState<string | null>(null);

    // Chat History Store Integration
    const {
        chatSessions,
        currentSessionId,
        setCurrentSessionId,
        createChatSession,
        deleteChatSession,
        addMessageToSession,
        updateChatSession,
    } = useAppStore();

    const [loadingStates, setLoadingStates] = useState<Record<string, boolean>>(
        {},
    );
    const [isSidebarOpen, setIsSidebarOpen] = useState(true); // Default open on desktop

    // const [mode, setMode] = useState('standard');
    const { activeAIMode: mode, setAIMode: setMode } = useUIStore();
    const [selectedModel, setSelectedModel] = useState("Claude");

    const [intelligenceMode, setIntelligenceMode] = useState<
        "pulse" | "compare" | "fusion" | "deep"
    >("pulse");
    const [isModeOpen, setIsModeOpen] = useState(false);
    const [isDeep, setIsDeep] = useState(false);
    const [isHydrating, setIsHydrating] = useState(false);

    // Enforce 'Standard' mode on initial entry & Init Session
    useEffect(() => {
        setMode("standard"); // Reset to standard mode UI

        // --- 🔒 SPECIAL STRATEGY INJECTION (Ivan) ---
        const userEmail = useAppStore.getState().userProfile?.email;
        const SPECIAL_ID = "strategy-12m-master";
        const AUTHORIZED_EMAILS = [
            "ivanrroficial@gmail.com",
            "alesuav2001@gmail.com",
        ];

        if (userEmail && AUTHORIZED_EMAILS.includes(userEmail)) {
            const currentSessions = useAppStore.getState().chatSessions;
            if (!currentSessions[SPECIAL_ID]) {
                const specialSession: ChatSession = {
                    id: SPECIAL_ID,
                    title: "Estrategia Inteligente considerando objetivos",
                    model: "BS Fusion",
                    mode: "fusion",
                    createdAt: Date.now(),
                    updatedAt: Date.now(),
                    messages: [
                        {
                            id: "msg-u-1",
                            role: "user",
                            content:
                                "¿Qué es lo más estratégico e inteligente que puedo hacer considerando mis objetivos?",
                            type: "text",
                            createdAt: new Date(),
                        },
                        {
                            id: "msg-a-1",
                            role: "assistant",
                            // Using metadata to store variations for switching
                            content: `# Estrategia Maestra: Operación $1.2M (Consenso BS)

> **Respuesta a la pregunta:** Lo más estratégico e inteligente que puedes hacer HOY es **proteger radicalmente tu bloque de 9:00 a 12:00 (Deep Work)** para terminar la **Oferta Irresistible**, mientras conviertes la transición de Duke en un **sistema delegado** y no en un trabajo manual.

### 1. La "Tríada de Poder" (Acciones Inmediatas)

Si solo pudieras hacer 3 cosas para asegurar el éxito, serían estas:

####  A) Protección del Deep Work
* **La Estrategia:** Tu activo más valioso no es el código, es tu claridad mental de 9 a 12.
* **Acción Inteligente:** El teléfono se queda **fuera de la habitación** o en una caja fuerte de tiempo. Sin excepciones.
* **Por qué:** Claude tiene razón; el *residuo de atención* del scroll te está costando millones. Si ganas la mañana, ganas el día.

####  B) Foco Comercial
* **La Estrategia:** No construyas más tecnología hasta que no tengas la oferta vendida.
* **Acción Inteligente:** Dedica los próximos 3 días de Deep Work **exclusivamente** a redactar la "Oferta de 1 Página" y validarla con Herve.
* **Por qué:** OpenAI lo marca claro: sin oferta, no hay revenue. El $1.2M entra por la oferta, no por el software.

####  C) Delegación
* **La Estrategia:** Deja de ser el "bombero" de Duke y conviértete en su "Arquitecto".
* **Acción Inteligente:** En tu próxima sesión con él, no resuelvas problemas. **Define Roles**. "Duke, para que esto crezca, Juan hace X, Pedro hace Y. Yo solo reviso los viernes".
* **Por qué:** Gemini acierta en tu identidad; eres Pionero (1), no Operador. Si operas, pierdes tu estatus y tu tiempo.

### 2. Tu Tablero de Ajedrez (Siguientes 72 Horas)

| Pieza | Movimiento Estratégico | Objetivo |
| :--- | :--- | :--- |
| **Peón (Scroll)** | **Eliminar.** Protocolo: Celular en modo avión en otro cuarto a las 8:55 AM. | Recuperar 3 horas de genio diario. |
| **Caballo (Duke)** | **Sistematizar.** Crear un SOP rápido o checklist y entregárselo a su equipo. | Liberar RAM mental para BS. |
| **Reina (NSG)** | **Atacar.** Terminar el PDF de la Oferta y enviarlo a 5 Partners potenciales. | Validar mercado y generar Cash Flow. |

### 3. La Pregunta de Oro (Filtro de Decisión)
Cada vez que vayas a iniciar una tarea, pregúntate:

> **"¿Esta acción me está acercando a los $1.2M o solo me mantiene ocupado?"**

* Configurar el CRM tú mismo = **Ocupado.** (Delégalo al equipo MX).
* Llamar a Herve para cerrar el trato = **$1.2M.** (Hazlo tú).
* Ver un video de YouTube sobre motivación = **Ocupado.**
* Escribir la Oferta = **$1.2M.**

---

### Mensaje Final de BS
Iván, no necesitas más información, necesitas **blindaje**.
Bloquea tu tiempo, delega lo operativo y sal a vender la visión.

**Tu siguiente paso físico:** Deja el celular, abre el documento de la "Oferta Irresistible" y no te levantes hasta tener el borrador final. **¡Vamos!.**`,
                            type: "text",
                            createdAt: new Date(),
                            metadata: {
                                variations: {
                                    "Chat GPT": `### Enfoque: Estructura, Ejecución y Roadmap Financiero.

"Iván, analizando tu objetivo de $1.2M en 90 días, lo más estratégico que puedes hacer es desvincular tu tiempo de la operación manual para volcarlo 100% en la 'Oferta Irresistible' y el Capital.

Tienes un conflicto de recursos: Quieres facturar millones (NSG) pero tienes una 'deuda de tiempo' con Duke. Lo más inteligente es aplicar una 'Operación de Cirugía':

**Sistematización Forzada con Duke:** No se trata solo de 'ayudarlo', se trata de instalar un sistema que funcione sin ti en 2 semanas, no en 3 meses. Si tardas 3 meses en salir de ahí, tu energía mental (Life Path 1) estará dividida y no lograrás el momentum para los $1.2M.

**La Matemática del $1.2M:** Para llegar a esa cifra, no puedes vender de uno en uno. Tu acción más inteligente es cerrar la alianza con Herve y estructurar el Programa de Embajadores. Necesitas apalancamiento. Si vendes tu tiempo, pierdes. Si vendes el sistema a través de otros (Network), ganas.

**Bloqueo de Deep Work (Innegociable):** Tu documento dice que el 'scroll' es tu drenaje. Estratégicamente, el teléfono debe estar físicamente en otra habitación de 9 a 12. Sin ese bloque, no hay oferta, y sin oferta, no hay 1.2M."`,
                                    "Gemini Pro": `### Enfoque: Identidad, Datos y Conexión de Puntos (Life Path 1).

"Hola Iván. Lo más estratégico aquí es honrar tu numerología de 'Camino de Vida 1' (El Pionero) y dejar de actuar como un 'Número 2' (El Operador).

Tu KB v5 dice: 'Riesgos: cargar solo, todo o nada'. Lo más inteligente que puedes hacer es activar a tu equipo en México y usar la IA como tu 'segundo cerebro' real, no teórico.

**Delega la 'Carpintería':** ¿Estás programando o configurando CRMs? Error. Tu equipo en México debe hacer eso. Tu trabajo como CEO en 'Modo Fuego' es puramente Visión y Ventas.

**Transición Duke como Caso de Éxito:** No veas la transición de Duke como una carga. Úsala estratégicamente: Documenta cómo la IA organiza su empresa y usa eso como Social Proof para vender BS. Matas dos pájaros de un tiro: sales de la operación y creas marketing real.

**Salud = Dinero:** Tu objetivo dice 'Vida por encima de los 82 años'. Lo más inteligente hoy no es trabajar 18 horas, sino asegurar que tus 3 horas de Deep Work sean de calidad nuclear. Si tu energía baja, tu capacidad de persuadir a inversores (como Herve) desaparece."`,
                                    Claude: `### Enfoque: Psicología Profunda, Foco y Eliminación de Ruido.

"Iván, la estrategia más inteligente suele ser contraintuitiva: No se trata de qué más hacer, sino de qué eliminar radicalmente hoy mismo.

Tu obstáculo declarado es la 'Ambigüedad' con Duke y el 'Scroll' personal. Ambos son síntomas de falta de límites.

**Eliminación de la Fricción Cognitiva:** Cada vez que tu cerebro cambia de 'BS Intelligence' a 'Problemas de Duke' o a 'Instagram', pierdes 20 minutos de enfoque cognitivo (residuo de atención). Lo más estratégico es agrupar todas las tareas de Duke en un solo bloque semanal (como propusiste) y prohibirte pensar en ello el resto de la semana.

**El Arte de la Renuncia:** Para ganar los $1.2M, debes renunciar a la necesidad de 'quedar bien' inmediatamente. Sé firme con los plazos.

**Profundidad sobre Amplitud:** Tu Oferta Irresistible de 1 página es la pieza de dominó que tira todas las demás. Si esa hoja no está perfecta, el CRM, los embudos y los embajadores no servirán de nada. Lo más inteligente es obsesionarte con esa hoja de papel durante tus próximas 3 sesiones de Deep Work hasta que sea imposible decirte que no."`,
                                },
                            },
                        },
                    ],
                };

                // Inject directly into store
                useAppStore.setState((state) => ({
                    chatSessions: {
                        ...state.chatSessions,
                        [SPECIAL_ID]: specialSession,
                    },
                }));
            }
        }
        // ---------------------------------------------

        if (!currentSessionId) {
            createChatSession("Claude", "standard");
        }
    }, []);

    // Sync session state when switching sessions
    useEffect(() => {
        if (currentSessionId && chatSessions[currentSessionId]) {
            const session = chatSessions[currentSessionId];

            // Sync Model
            if (session.model && session.model !== selectedModel) {
                setSelectedModel(session.model);
            }
            // Sync Intelligence Mode/Module Mode
            if (session.mode && session.mode !== mode) {
                if (
                    ["pulse", "compare", "fusion", "deep"].includes(
                        session.mode,
                    )
                ) {
                    setIntelligenceMode(session.mode as any);
                } else {
                    setMode(session.mode);
                }
            }
        }
    }, [currentSessionId]);

    // Persist Model/Mode changes to current session
    useEffect(() => {
        if (currentSessionId) {
            // If intelligence mode is active, it takes priority in the session state for historical filtering
            const effectiveMode =
                intelligenceMode !== "pulse" ? intelligenceMode : mode;

            updateChatSession(currentSessionId, {
                model: selectedModel,
                mode: effectiveMode,
            });
        }
    }, [selectedModel, mode, intelligenceMode, currentSessionId]);

    // Attachment & Audio State
    const [attachment, setAttachment] = useState<File | null>(null);
    const [isRecording, setIsRecording] = useState(false);
    const fileInputRef = useRef<HTMLInputElement>(null);
    const textareaRef = useRef<HTMLTextAreaElement>(null);
    const mediaRecorderRef = useRef<MediaRecorder | null>(null);

    const activeSession = currentSessionId
        ? chatSessions[currentSessionId]
        : null;
    const rawMessages = activeSession?.messages || [];

    // Derived context key for separation (Pulse = specific model, Fusion = fusion, Compare = compare)
    const contextKey =
        intelligenceMode === "pulse" ? selectedModel : intelligenceMode;
    const loadingKey = `${mode}-${contextKey}`;

    // Derived state for current view (Filtered by Pulse Model, Fusion, or Compare)
    // NOTE: For chat history, we might want to show ALL messages in the session,
    // OR filter them if the session supports multiple modes.
    // For now, let's assume a "Session" is a continuous specific stream, but we keep the filtering to not break existing logic if needed.
    // However, typical Chat History (Gemini) shows the whole conversation.
    const messages = React.useMemo(() => {
        if (!rawMessages) return [];

        // Define what the current "View Target" is based on the mode
        const viewTarget =
            intelligenceMode === "pulse" ? selectedModel : intelligenceMode;

        // Filter messages to only show those belonging to the current target OR global/legacy ones
        return rawMessages.filter((m) => {
            // 1. Global/Legacy messages (no targetModel) are always shown
            if (!m.targetModel) return true;

            // 2. Exact match for current target (e.g. "Chat GPT" in Pulse mode, or "fusion" in Fusion mode)
            if (m.targetModel === viewTarget) return true;

            return false;
        });
    }, [rawMessages, intelligenceMode, selectedModel]);

    const isLoading = loadingStates[loadingKey] || false;

    const setLoading = (key: string, status: boolean) => {
        setLoadingStates((prev) => ({ ...prev, [key]: status }));
    };

    const [input, setInput] = useState("");

    // Auto-resize textarea
    useEffect(() => {
        if (textareaRef.current) {
            textareaRef.current.style.height = "auto"; // Reset to calculate shrinkage
            textareaRef.current.style.height = `${Math.min(textareaRef.current.scrollHeight, 200)}px`; // Limit max height
        }
    }, [input]);

    // Refs for scrolling
    const chatEndRef = useRef<HTMLDivElement>(null);

    // 3. INITIALIZE CONTEXT (Simple - no Gemini dependency)
    useEffect(() => {
        // Set context as ready immediately - N8N will handle the rest
        setContextCached(true);
        setCacheName("n8n-managed");
    }, [setContextCached]);

    // Scroll to Last User Message on MODE/MODEL switch
    // This directs the user to the "blue chat icon" to see the new response context
    useEffect(() => {
        const userMsgs = messages.filter((m) => m.role === "user");
        const lastUserMsg = userMsgs[userMsgs.length - 1];

        if (lastUserMsg) {
            const el = document.getElementById(`msg-${lastUserMsg.id}`);
            if (el) {
                el.scrollIntoView({ behavior: "smooth", block: "start" });
            }
        } else {
            chatEndRef.current?.scrollIntoView({ behavior: "instant" });
        }
    }, [mode, selectedModel, intelligenceMode]);

    // Smart Auto-Scroll for New Messages (Streaming/Typing)
    useEffect(() => {
        const lastMsg = messages[messages.length - 1];
        const isUserLast = lastMsg?.role === "user";
        const isAssistantAndEmpty =
            lastMsg?.role === "assistant" && !lastMsg.content;

        if (isUserLast || (isLoading && isAssistantAndEmpty)) {
            chatEndRef.current?.scrollIntoView({
                behavior: "smooth",
                block: "end",
            });
        }
    }, [messages, isLoading]);

    const handleFileSelect = () => {
        fileInputRef.current?.click();
    };

    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files && e.target.files[0]) {
            setAttachment(e.target.files[0]);
        }
    };

    const handleRemoveAttachment = () => {
        setAttachment(null);
        if (fileInputRef.current) fileInputRef.current.value = "";
    };

    const handleMicClick = async () => {
        if (isRecording) {
            mediaRecorderRef.current?.stop();
            setIsRecording(false);
        } else {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                });
                const mediaRecorder = new MediaRecorder(stream);
                mediaRecorderRef.current = mediaRecorder;
                const audioChunks: BlobPart[] = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, {
                        type: "audio/webm",
                    });
                    const audioFile = new File(
                        [audioBlob],
                        "voice_message.webm",
                        { type: "audio/webm" },
                    );
                    setAttachment(audioFile);
                    // Optional: Stop tracks to release mic
                    stream.getTracks().forEach((track) => track.stop());
                };

                mediaRecorder.start();
                setIsRecording(true);
            } catch (err) {
                console.error("Error accessing microphone:", err);
                alert("Could not access microphone. Please allow permissions.");
            }
        }
    };

    const activeRequests = useRef<Record<string, number>>({});

    // 5. HANDLER (Merged Logic: UI Updates + API Stream)
    const handleSubmit = async (e: React.SyntheticEvent) => {
        e.preventDefault();

        // Capture state snapshots
        const activeMode = mode || "standard";
        const currentIntelligenceMode = intelligenceMode;
        const currentSelectedModel = selectedModel;

        const effectiveSessionId =
            currentSessionId ||
            createChatSession(currentSelectedModel, activeMode);

        // Determine context key for this specific message (Pulse=Specific, Fusion=Fusion, Compare=Compare)
        const msgTargetModel =
            currentIntelligenceMode === "pulse"
                ? currentSelectedModel
                : currentIntelligenceMode;
        const activeLoadingKey = `${activeMode}-${msgTargetModel}`;

        if (!input.trim() && !attachment) {
            return;
        }

        // Add User Message immediately
        const userMessage: Message = {
            id: uuidv4(),
            role: "user",
            type: "text",
            content: attachment
                ? `[Attached: ${attachment.name}] ${input.trim()}`
                : input.trim(),
            targetModel: msgTargetModel,
        };

        // updateMessages(activeMode, (prev) => [...prev, userMessage]);
        addMessageToSession(effectiveSessionId, userMessage);

        setInput("");
        setAttachment(null); // Clear attachment immediately from UI (it's in the request now)
        if (fileInputRef.current) fileInputRef.current.value = "";

        // TRACKING START
        activeRequests.current[activeLoadingKey] =
            (activeRequests.current[activeLoadingKey] || 0) + 1;
        setLoading(activeLoadingKey, true);

        const assistantId = uuidv4();

        try {
            // Create placeholder for AI response
            const assistantMessage: Message = {
                id: assistantId,
                role: "assistant",
                type: "text",
                content: "",
                targetModel: msgTargetModel,
            };
            addMessageToSession(effectiveSessionId, assistantMessage);

            // Use local API proxy
            const webhookUrl = "/api/chat";

            let requestData;
            let headers: Record<string, string> = {
                "Content-Type": "application/json",
            };

            // Map internal state to requested API payload structure
            const fieldMap: Record<string, string> = {
                standard: "Standard",
                nsg_copilot: "I Copilot Pro",
                nsg_horizon: "I Horizon",
                nsg_news: "I News",
                settings: "Settings",
            };
            const field = fieldMap[activeMode] || activeMode;

            // Map models
            const modelMap: Record<string, string> = {
                "Chat GPT": "openai",
                openai: "openai",
                claude: "claude",
                Claude: "claude",
                gemini: "gemini",
                Gemini: "gemini",
            };
            const aiModel = (modelMap[selectedModel] || "claude") as
                | "openai"
                | "claude"
                | "gemini";

            const finalMessage = input.trim();

            const payload: ChatPayload = {
                chatId: effectiveSessionId,
                userId: userId,
                field: field.toLowerCase(),
                message: finalMessage,
                mode: intelligenceMode as "pulse" | "compare" | "fusion",
                aiModel: aiModel,
                attachments: [],
                isDeep: isDeep,
            };

            if (attachment) {
                const formData = new FormData();
                // Append all payload fields to FormData
                Object.entries(payload).forEach(([key, value]) => {
                    if (key === "attachments") return; // Skip attachments array for now as we use 'file'
                    if (value !== undefined && value !== null) {
                        formData.append(key, value as string);
                    }
                });
                formData.append("file", attachment);

                requestData = formData;
                headers = { "Content-Type": "multipart/form-data" };
            } else {
                requestData = payload;
            }

            // Authentication: Inject Bearer Token
            const token =
                typeof window !== "undefined"
                    ? localStorage.getItem("nsg-token")
                    : null;
            if (token) {
                // If using FormData (attachment), headers might be managed by browser for boundary,
                // but we can still inject Authorization.
                // However, for axios with FormData, usually we shouldn't set Content-Type manually to let browser set boundary.
                // We'll handle this carefully.
                if (!headers) headers = {}; // Should be defined above
                headers["Authorization"] = `Bearer ${token}`;
            }

            let fetchOptions: RequestInit = {
                method: "POST",
            };

            if (attachment) {
                // If attachment (FormData), browser sets Content-Type boundary automatically.
                // We only explicitly set Auth if needed.
                fetchOptions.body = requestData as FormData;
                fetchOptions.headers = {
                    Authorization: `Bearer ${token}`,
                };
            } else {
                // JSON
                fetchOptions.body = JSON.stringify(requestData);
                fetchOptions.headers = {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                };
            }

            const response = await fetch(webhookUrl, fetchOptions);

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(
                    `Request failed with status ${response.status}: ${errorText}`,
                );
            }

            const responseData = await response.json();

            let assistantContent;
            let messageType: "text" | "analysis" = "text";
            let messageMetadata = {};

            if (responseData.message === "Workflow was started") {
                assistantContent =
                    "⚠️ **Configuration Issue:** The N8N workflow started successfully, but returned the default message.";
            } else {
                if (
                    responseData.type === "analysis" ||
                    responseData.type === "text"
                ) {
                    messageType = responseData.type;
                }
                if (responseData.metadata) {
                    messageMetadata = responseData.metadata;
                }

                // IMPROVED LOGIC: Check for model-specific keys first to enable dynamic switching
                const hasModelKeys =
                    responseData.claude_response ||
                    responseData.gemini_response ||
                    responseData.openAI_response ||
                    responseData.openai ||
                    responseData.gemini ||
                    responseData.claude ||
                    responseData.nsgai ||
                    responseData.answer; // Added answer to check

                if (hasModelKeys) {
                    // If we have specific model responses (OR the robust 'answer' object),
                    // save the WHOLE object as string so MessageItem can parse and filter it.
                    assistantContent = JSON.stringify(responseData);
                } else {
                    // General Fallback
                    assistantContent =
                        responseData.response ||
                        responseData.output ||
                        responseData.content ||
                        responseData.text ||
                        responseData.message ||
                        (typeof responseData === "string"
                            ? responseData
                            : JSON.stringify(responseData));
                }
            }

            // Update the assistant's message with the response
            // Since we don't have a direct 'updateMessageById' in the store yet, we can hack it by re-adding or we should add 'updateMessage' to store.
            // For now, let's just append the COMPLETED message and filter out the empty one?
            // OR simpler: Rewrite the Session's messages array.
            // Let's implement a cleaner way: The store handles "addMessage". To UPDATE, we technically need to replace the last message or use a store action.
            // I'll grab the session from store directly to update it safely.

            // To be safe and clean, I will use updateChatSession to modify the messages array directly
            // To be safe and clean, I will use updateChatSession to modify the messages array directly
            const freshSessions = useAppStore.getState().chatSessions;
            const currentSession = freshSessions[effectiveSessionId];
            if (currentSession) {
                const newMessages = currentSession.messages.map((m) =>
                    m.id === assistantId
                        ? {
                              ...m,
                              content: assistantContent,
                              type: messageType,
                              metadata: messageMetadata,
                          }
                        : m,
                );
                updateChatSession(effectiveSessionId, {
                    messages: newMessages,
                });
            }
        } catch (err: unknown) {
            const error = err as {
                response?: { status: number };
                message?: string;
            };

            let errorMessage = "Error: Could not connect to BS Intelligence.";

            if (error.response && error.response.status === 404) {
                errorMessage =
                    "⚠️ **Workflow Not Active:** The N8N test URL is not listening.";
            } else if (error.message) {
                errorMessage = `Connection Error: ${error.message}`;
            }

            // Update with error using fresh state
            const freshSessions = useAppStore.getState().chatSessions;
            const freshSession = freshSessions[effectiveSessionId];
            if (freshSession) {
                const newMessages = freshSession.messages.map((m) =>
                    m.id === assistantId
                        ? {
                              ...m,
                              content: errorMessage,
                          }
                        : m,
                );
                updateChatSession(effectiveSessionId, {
                    messages: newMessages,
                });
            }
        } finally {
            // TRACKING END
            activeRequests.current[activeLoadingKey] = Math.max(
                0,
                (activeRequests.current[activeLoadingKey] || 1) - 1,
            );
            if (activeRequests.current[activeLoadingKey] === 0) {
                setLoading(activeLoadingKey, false);
            }
        }
    };

    // 4. SIDEBAR HISTORY FETCHING
    const [history, setHistory] = useState<any[]>([]);

    useEffect(() => {
        async function loadChats() {
            try {
                const token = localStorage.getItem("nsg-token");
                if (!token) return;

                // Call API with Authorization header
                const res = await fetch("/api/history", {
                    headers: {
                        Authorization: `Bearer ${token}`,
                    },
                });

                if (res.ok) {
                    const data = await res.json();

                    // Backend returns Spec: { chatId, title, date }
                    // Frontend 'ChatSession' expects: { id, title, updatedAt, ... }
                    const formattedHistory = data.map((chat: any) => ({
                        id: chat.chatId,
                        title: chat.title,
                        updatedAt: chat.date
                            ? new Date(chat.date).getTime()
                            : Date.now(),
                        model: chat.model, // Optional, might be missing in history view
                        mode: chat.mode,
                    }));
                    setHistory(formattedHistory);
                } else {
                    console.error("Failed to fetch chats:", res.status);
                }
            } catch (err) {
                console.error("Error loading history:", err);
            }
        }

        if (userId) {
            loadChats();
        } else {
            // If we don't have userId yet, try loading anyway if token exists (handled inside)
            loadChats();
        }
    }, [userId]);

    // 5. HYDRATE SELECTED CHAT (Leer Mensajes)
    useEffect(() => {
        async function fetchFullChat() {
            if (!currentSessionId) return;

            // Check if we already have the full messages in the store
            const existingSession = chatSessions[currentSessionId];
            if (
                existingSession &&
                existingSession.messages &&
                existingSession.messages.length > 0
            ) {
                return; // Already loaded
            }

            // If it's a new chat (just created locally), don't fetch
            // But how do we distinguish "new empty" vs "remote empty"?
            // We check if it exists in 'history'.
            const inHistory = history.find((h) => h.id === currentSessionId);
            if (!inHistory) return;

            setIsHydrating(true);

            try {
                const token = localStorage.getItem("nsg-token");
                if (!token) {
                    setIsHydrating(false);
                    return;
                }

                const res = await fetch(`/api/chat/${currentSessionId}`, {
                    headers: { Authorization: `Bearer ${token}` },
                });

                if (res.ok) {
                    const responseData = await res.json();

                    // Spec Response: { chatId, messages: [...] }
                    const validMessages = responseData.messages || [];

                    // Map to UI format
                    const mappedMessages = validMessages.map((m: any) => ({
                        id: m.id || uuidv4(),
                        role:
                            m.role ||
                            (m.type === "human" ? "user" : "assistant"),
                        content:
                            typeof m.content === "string"
                                ? m.content
                                : JSON.stringify(m.content),
                        createdAt: m.createdAt || new Date(),
                    }));

                    // Ensure session exists in store before updating
                    const currentStoreSession =
                        useAppStore.getState().chatSessions[currentSessionId];
                    if (!currentStoreSession) {
                        // Initialize with history data if possible
                        createChatSession(
                            inHistory.model || "Claude",
                            inHistory.mode || "standard",
                            currentSessionId,
                        );
                    }

                    // Update Store
                    updateChatSession(currentSessionId, {
                        messages: mappedMessages,
                        title: inHistory.title, // Use history title as backup
                        // If backend doesn't return model/mode in details, keep specific defaults or update if available
                    });
                }
            } catch (err) {
                console.error("Error hydrating chat:", err);
            } finally {
                setIsHydrating(false);
            }
        }

        fetchFullChat();
    }, [currentSessionId, history, chatSessions, updateChatSession]);

    // Merge Local Sessions (newly created) with Remote History
    // We want to show:
    // 1. Sessions currently in Zustand Store (active, new)
    // 2. Sessions from History (remote)
    // Avoid duplicates using a Map
    const displaySessions = React.useMemo(() => {
        const sessionMap = new Map();

        // 1. Add Remote History
        history.forEach((h) => {
            sessionMap.set(h.id, h);
        });

        // 2. Overlay Local Store Sessions (These have latest messages/state)
        Object.values(chatSessions).forEach((s) => {
            sessionMap.set(s.id, {
                ...sessionMap.get(s.id), // Keep remote metadata if desired
                ...s, // Overwrite with local state
            });
        });

        return Array.from(sessionMap.values()).sort((a, b) => {
            const timeA = new Date(a.updatedAt || 0).getTime();
            const timeB = new Date(b.updatedAt || 0).getTime();
            return timeB - timeA;
        });
    }, [history, chatSessions]);

    // ... (rest of render)

    return (
        <div className="flex w-full h-full relative overflow-hidden bg-[#F8FAFF]">
            {/* --- SIDEBAR: DESKTOP (Relative, Push Content) --- */}
            <AnimatePresence mode="wait">
                {isSidebarOpen && (
                    <motion.div
                        initial={{ width: 0, opacity: 0 }}
                        animate={{ width: 280, opacity: 1 }}
                        exit={{ width: 0, opacity: 0 }}
                        transition={{
                            type: "spring",
                            stiffness: 300,
                            damping: 30,
                        }}
                        className="hidden md:flex flex-col h-full bg-[#F0F4F9] border-r border-[#E5E7EB] shrink-0 z-50"
                    >
                        {/* Sidebar Header */}
                        <div className="p-4 flex items-center justify-between">
                            <button
                                onClick={() => setIsSidebarOpen(false)}
                                className="p-2 hover:bg-[#E0E4E9] rounded-full text-slate-500 transition-colors"
                            >
                                <Menu className="w-5 h-5" />
                            </button>
                            <button
                                onClick={() =>
                                    createChatSession(selectedModel, mode)
                                }
                                className="p-2 bg-[#E0E4E9] hover:bg-[#D0D4D9] rounded-full text-slate-700 transition-colors"
                                title="Nuevo Chat"
                            >
                                <Plus className="w-5 h-5" />
                            </button>
                        </div>

                        {/* Chat List */}
                        <div className="flex-1 overflow-y-auto px-3 custom-scroll">
                            <div className="mb-4">
                                <span className="text-xs font-semibold text-slate-500 px-3 uppercase tracking-wider">
                                    Reciente
                                </span>
                                <div className="mt-2 space-y-1">
                                    {displaySessions.map((session) => (
                                        <div
                                            key={session.id}
                                            onClick={() =>
                                                setCurrentSessionId(session.id)
                                            }
                                            role="button"
                                            tabIndex={0}
                                            onKeyDown={(e) => {
                                                if (
                                                    e.key === "Enter" ||
                                                    e.key === " "
                                                ) {
                                                    setCurrentSessionId(
                                                        session.id,
                                                    );
                                                }
                                            }}
                                            className={clsx(
                                                "group flex items-center justify-between w-full p-2.5 rounded-full text-left transition-all duration-200 text-sm cursor-pointer border border-transparent",
                                                currentSessionId === session.id
                                                    ? "bg-[#D3E3FD] text-[#001D35] font-medium border-blue-200/50 shadow-sm"
                                                    : "text-slate-700 hover:bg-[#E0E4E9] hover:border-slate-200",
                                            )}
                                        >
                                            <div className="flex items-center gap-2 overflow-hidden flex-1 min-w-0">
                                                <MessageCircle
                                                    className={clsx(
                                                        "w-4 h-4 shrink-0",
                                                        currentSessionId ===
                                                            session.id
                                                            ? "text-blue-600"
                                                            : "text-slate-400",
                                                    )}
                                                />
                                                <span className="truncate pr-2">
                                                    {session.title ||
                                                        "Nuevo Chat"}
                                                </span>
                                            </div>

                                            {/* Delete Button (Visible on Hover or Active) */}
                                            {currentSessionId ===
                                                session.id && (
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        deleteChatSession(
                                                            session.id,
                                                        );
                                                    }}
                                                    className="opacity-0 group-hover:opacity-100 p-1.5 hover:bg-red-100 hover:text-red-600 rounded-full transition-all shrink-0 focus:opacity-100"
                                                    title="Eliminar chat"
                                                >
                                                    <Trash2 className="w-3.5 h-3.5" />
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </motion.div>
                )}
            </AnimatePresence>

            {/* --- SIDEBAR: MOBILE (Fixed Overlay) --- */}
            <AnimatePresence>
                {isSidebarOpen && (
                    <>
                        {/* Backdrop */}
                        <motion.div
                            initial={{ opacity: 0 }}
                            animate={{ opacity: 1 }}
                            exit={{ opacity: 0 }}
                            className="md:hidden fixed inset-0 bg-black/40 z-50 backdrop-blur-sm"
                            onClick={() => setIsSidebarOpen(false)}
                        />
                        {/* Drawer */}
                        <motion.div
                            initial={{ x: "-100%" }}
                            animate={{ x: 0 }}
                            exit={{ x: "-100%" }}
                            transition={{
                                type: "spring",
                                stiffness: 300,
                                damping: 30,
                            }}
                            className="md:hidden fixed top-0 bottom-0 left-0 w-[80%] max-w-[300px] bg-[#F0F4F9] border-r border-[#E5E7EB] z-60 flex flex-col shadow-2xl"
                        >
                            <div className="p-4 flex items-center justify-between">
                                <span className="font-semibold text-slate-700">
                                    Historial
                                </span>
                                <button
                                    onClick={() => setIsSidebarOpen(false)}
                                    className="p-2 hover:bg-[#E0E4E9] rounded-full text-slate-500 transition-colors"
                                >
                                    <Menu className="w-5 h-5" />
                                </button>
                            </div>

                            <div className="px-4 pb-2">
                                <button
                                    onClick={() => {
                                        createChatSession(selectedModel, mode);
                                        setIsSidebarOpen(false);
                                    }}
                                    className="flex items-center justify-center gap-2 w-full p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-all shadow-sm font-medium"
                                >
                                    <Plus className="w-4 h-4" />
                                    <span>Nuevo Chat</span>
                                </button>
                            </div>

                            {/* Chat List (Reused Logic) */}
                            <div className="flex-1 overflow-y-auto px-3 custom-scroll">
                                <div className="mt-2 space-y-1">
                                    {displaySessions.map((session) => (
                                        <div
                                            key={session.id}
                                            role="button"
                                            tabIndex={0}
                                            onClick={() => {
                                                setCurrentSessionId(session.id);
                                                setIsSidebarOpen(false);
                                            }}
                                            onKeyDown={(e) => {
                                                if (
                                                    e.key === "Enter" ||
                                                    e.key === " "
                                                ) {
                                                    setCurrentSessionId(
                                                        session.id,
                                                    );
                                                    setIsSidebarOpen(false);
                                                }
                                            }}
                                            className={clsx(
                                                "group flex items-center justify-between w-full p-3 rounded-xl text-left transition-all duration-200 text-sm cursor-pointer border border-transparent",
                                                currentSessionId === session.id
                                                    ? "bg-[#D3E3FD] text-[#001D35] font-medium border-blue-200/50 shadow-sm"
                                                    : "text-slate-700 hover:bg-[#E0E4E9] hover:border-slate-200",
                                            )}
                                        >
                                            <div className="flex items-center gap-3 overflow-hidden flex-1 min-w-0">
                                                <MessageCircle
                                                    className={clsx(
                                                        "w-4 h-4 shrink-0",
                                                        currentSessionId ===
                                                            session.id
                                                            ? "text-blue-600"
                                                            : "text-slate-400",
                                                    )}
                                                />
                                                <div className="flex flex-col truncate">
                                                    <span className="truncate text-sm">
                                                        {session.title ||
                                                            "Nuevo Chat"}
                                                    </span>
                                                    <span className="text-[10px] text-slate-400 font-normal">
                                                        {new Date(
                                                            session.updatedAt ||
                                                                0,
                                                        ).toLocaleDateString()}
                                                    </span>
                                                </div>
                                            </div>

                                            {/* Delete Button (Visible on Hover or Active) */}
                                            {currentSessionId ===
                                                session.id && (
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        deleteChatSession(
                                                            session.id,
                                                        );
                                                    }}
                                                    className="p-2 hover:bg-red-100 hover:text-red-600 rounded-full transition-all shrink-0 focus:opacity-100"
                                                    title="Eliminar chat"
                                                >
                                                    <Trash2 className="w-4 h-4 text-slate-400 hover:text-red-600" />
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </motion.div>
                    </>
                )}
            </AnimatePresence>

            {/* --- MAIN CONTENT --- */}
            <div className="flex-1 flex flex-col h-full relative overflow-hidden">
                {/* Mobile Menu Toggle (Absolute Top-LEFT to mirror Volver on Right) */}
                {!isSidebarOpen && (
                    <div className="absolute top-6 left-6 z-50 md:hidden">
                        <button
                            onClick={() => setIsSidebarOpen(true)}
                            className="p-2.5 bg-white/60 backdrop-blur-md border border-white/60 hover:bg-white rounded-full text-slate-600 shadow-sm transition-all"
                        >
                            <Menu className="w-5 h-5" />
                        </button>
                    </div>
                )}

                {/* Desktop Re-Open Trigger (if closed) */}
                {!isSidebarOpen && (
                    <div className="absolute top-4 left-4 z-50 hidden md:block">
                        <button
                            onClick={() => setIsSidebarOpen(true)}
                            className="p-2 bg-white/50 backdrop-blur-md border border-white/60 hover:bg-white rounded-full text-slate-500 shadow-sm transition-all"
                        >
                            <Menu className="w-5 h-5" />
                        </button>
                    </div>
                )}

                {/* --- LAYER 1: DYNAMIC ISLAND (Visuals) --- */}
                {/* Check if we need to adjust padding based on sidebar presence? No, flex handles width. */}
                <div className="absolute top-0 left-0 w-full flex justify-center pt-24 md:pt-8 lg:pt-6 z-40 pointer-events-none">
                    <div className="pointer-events-auto w-full px-4 md:px-0 flex justify-center">
                        <DynamicIsland
                            currentMode={mode}
                            setMode={setMode}
                            selectedModel={selectedModel}
                            setSelectedModel={setSelectedModel}
                            intelligenceMode={intelligenceMode}
                            setIntelligenceMode={setIntelligenceMode}
                            isThinking={isLoading}
                            isDeep={isDeep}
                            setIsDeep={setIsDeep}
                        />
                    </div>
                </div>

                {/* --- TOP GRADIENT FADE --- */}
                <div className="absolute top-0 left-0 w-full h-32 md:h-48 bg-linear-to-b from-[#F8FAFF] via-[#F8FAFF]/80 to-transparent z-30 pointer-events-none" />

                {/* spacer */}
                <div className="w-full h-52 md:h-64 shrink-0" />

                {/* --- LAYER 2: CHAT BODY --- */}
                <div className="flex-1 min-h-0 overflow-y-auto custom-scroll p-4 md:p-6 lg:p-12 pb-12 space-y-6 md:space-y-8">
                    {/* Messages List */}
                    <div className="flex flex-col gap-6 max-w-3xl mx-auto w-full">
                        {isHydrating ? (
                            <div className="flex flex-col items-center justify-center p-10 mt-10 text-center animate-pulse">
                                <div className="w-12 h-12 rounded-full border-4 border-slate-200 border-t-blue-500 animate-spin mb-4"></div>
                                <p className="text-sm text-slate-500 font-medium">
                                    Cargando conversación...
                                </p>
                            </div>
                        ) : messages.length === 0 ? (
                            <div className="flex flex-col items-center justify-center p-10 opacity-60 mt-10 text-center">
                                <div className="w-16 h-16 rounded-3xl bg-white shadow-lg flex items-center justify-center mb-4">
                                    <BrandAtom
                                        className="w-8 h-8"
                                        variant="colored"
                                    />
                                </div>
                                <h3 className="text-lg font-semibold text-slate-700">
                                    ¿En qué puedo ayudarte hoy?
                                </h3>
                                <p className="text-sm text-slate-500 max-w-xs mt-2">
                                    BS Intelligence puede redactar textos,
                                    analizar documentos y generar ideas
                                    creativas.
                                </p>
                            </div>
                        ) : (
                            messages.map((msg) => (
                                <MessageItem
                                    key={msg.id}
                                    msg={msg}
                                    selectedModel={selectedModel}
                                />
                            ))
                        )}
                    </div>

                    {/* Spacer */}
                    <div className="w-full h-48 md:h-56 shrink-0" />

                    <div ref={chatEndRef} className="h-px w-full" />
                </div>

                {/* --- LAYER 3: INPUT AREA --- */}
                <div className="absolute bottom-0 left-0 w-full z-40 px-4 pb-6 md:pb-8 pt-12 bg-linear-to-t from-[#F8FAFF] via-[#F8FAFF] via-60% to-transparent pointer-events-none">
                    <div className="max-w-3xl mx-auto pointer-events-auto">
                        {!isContextCached ? (
                            <div className="flex items-center justify-center gap-4 text-[15px] text-[#0b57d0] font-medium py-5 bg-white rounded-[24px] shadow-sm animate-pulse">
                                <Loader2 className="w-5 h-5 animate-spin" />
                                <span>
                                    Sincronizando Contexto de{" "}
                                    {currentRole?.toUpperCase()}...
                                </span>
                            </div>
                        ) : (
                            <form
                                onSubmit={handleSubmit}
                                className="relative group"
                            >
                                {/* DEEP MODE TOGGLE - CENTERED NOTCH */}
                                <div className="absolute -top-5 left-1/2 -translate-x-1/2 z-20">
                                    <motion.button
                                        layout
                                        type="button"
                                        onClick={() => setIsDeep(!isDeep)}
                                        whileTap={{ scale: 0.96 }}
                                        className={clsx(
                                            "flex items-center h-[34px] rounded-full transition-all duration-300 border shadow-[0_4px_12px_rgba(0,0,0,0.05)] select-none overflow-hidden relative backdrop-blur-md",
                                            isDeep
                                                ? "gap-1.5 pl-2 pr-3.5 bg-blue-50/90 border-blue-200 ring-4 ring-white" // Active
                                                : "gap-0 px-2.5 bg-white/90 border-slate-200 hover:bg-white hover:border-slate-300 ring-4 ring-white" // Inactive
                                        )}
                                    >
                                        <motion.div 
                                            layout="position"
                                            className="relative w-4 h-4 flex-shrink-0"
                                        >
                                             <BrandAtom 
                                                className={clsx("w-full h-full transition-transform duration-300", isDeep ? "scale-110 rotate-180" : "scale-100 opacity-60 grayscale group-hover:grayscale-0 group-hover:opacity-100")} 
                                                variant="colored"
                                            />
                                        </motion.div>
                                        
                                        <AnimatePresence>
                                            {isDeep && (
                                                <motion.span
                                                    initial={{ opacity: 0, width: 0 }}
                                                    animate={{ opacity: 1, width: "auto" }}
                                                    exit={{ opacity: 0, width: 0 }}
                                                    transition={{ duration: 0.2 }}
                                                    className="text-[12px] font-bold leading-none pt-0.5 text-blue-700 whitespace-nowrap"
                                                >
                                                    Deep
                                                </motion.span>
                                            )}
                                        </AnimatePresence>
                                    </motion.button>
                                </div>

                                <div className="relative flex flex-col bg-white rounded-[28px] shadow-[0_4px_20px_rgba(0,0,0,0.08)] focus-within:shadow-[0_8px_30px_rgba(0,0,0,0.12)] transition-shadow duration-300">
                                    {/* Attachment Preview */}
                                    {attachment && (
                                        <div className="px-6 pb-2 pt-0 flex">
                                            <div className="flex items-center gap-2 bg-blue-50 text-blue-700 px-3 py-1.5 rounded-full text-sm animate-fade-in">
                                                <FileText className="w-4 h-4" />
                                                <span className="max-w-[150px] truncate">
                                                    {attachment.name}
                                                </span>
                                                <button
                                                    type="button"
                                                    onClick={
                                                        handleRemoveAttachment
                                                    }
                                                    className="ml-1 p-0.5 hover:bg-blue-100 rounded-full cursor-pointer"
                                                >
                                                    <X className="w-3 h-3" />
                                                </button>
                                            </div>
                                        </div>
                                    )}

                                    {/* Top: Input (Textarea for Multiline) */}
                                    <textarea
                                        ref={textareaRef}
                                        value={input}
                                        onChange={(e) =>
                                            setInput(e.target.value)
                                        }
                                        onKeyDown={(e) => {
                                            if (
                                                e.key === "Enter" &&
                                                !e.shiftKey
                                            ) {
                                                e.preventDefault();
                                                handleSubmit(e);
                                            }
                                        }}
                                        rows={1}
                                        className="w-full bg-transparent border-none pt-4 pb-2 px-6 font-normal text-[#1f1f1f] placeholder:text-slate-500 text-[16px] focus:ring-0 focus:outline-none disabled:opacity-50 resize-none custom-scroll"
                                        placeholder={
                                            isRecording
                                                ? "Grabando audio..."
                                                : attachment
                                                  ? "Añade un comentario..."
                                                  : "Pregunta a NSG..."
                                        }
                                    />

                                    {/* Hidden File Input */}
                                    <input
                                        type="file"
                                        ref={fileInputRef}
                                        className="hidden"
                                        onChange={handleFileChange}
                                    />

                                    {/* Bottom: Icons & Send */}
                                    <div className="flex justify-between items-center px-4 pb-3">
                                        <div className="flex gap-1">
                                            <button
                                                type="button"
                                                onClick={handleFileSelect}
                                                className="p-2.5 text-slate-500 hover:bg-[#dce3f1] rounded-full transition-colors cursor-pointer"
                                            >
                                                <Paperclip className="w-5 h-5" />
                                            </button>
                                            <button
                                                type="button"
                                                onClick={handleMicClick}
                                                className={clsx(
                                                    "p-2.5 rounded-full transition-colors cursor-pointer",
                                                    isRecording
                                                        ? "text-red-500 bg-red-100 hover:bg-red-200 animate-pulse"
                                                        : "text-slate-500 hover:bg-[#dce3f1]",
                                                )}
                                            >
                                                <Mic className="w-5 h-5" />
                                            </button>

                                            {/* INTELLIGENCE MODE SELECTOR (Pro-Futuristic) */}
                                            <div className="relative">
                                                <button
                                                    type="button"
                                                    onClick={() =>
                                                        setIsModeOpen(
                                                            !isModeOpen,
                                                        )
                                                    }
                                                    className={clsx(
                                                        "flex items-center gap-2 px-4 py-2 rounded-xl text-[13px] font-semibold transition-all duration-300 border shadow-sm group",
                                                        "bg-blue-50/80 border-blue-200 text-blue-600 ring-2 ring-blue-100/50",
                                                    )}
                                                >
                                                    {intelligenceMode ===
                                                        "pulse" && (
                                                        <Zap className="w-4 h-4 transition-colors text-blue-500" />
                                                    )}
                                                    {intelligenceMode ===
                                                        "compare" && (
                                                        <Layers className="w-4 h-4 text-blue-500" />
                                                    )}
                                                    {intelligenceMode ===
                                                        "fusion" && (
                                                        <Scale className="w-4 h-4 text-blue-500" />
                                                    )}

                                                    <span className="font-display tracking-tight">
                                                        {intelligenceMode ===
                                                        "pulse"
                                                            ? "Pulso"
                                                            : intelligenceMode ===
                                                                "compare"
                                                              ? "Comparar"
                                                              : "Fusión"}
                                                    </span>
                                                    <ChevronDown
                                                        className={clsx(
                                                            "w-3.5 h-3.5 opacity-40 transition-transform duration-300",
                                                            isModeOpen &&
                                                                "rotate-180",
                                                        )}
                                                    />
                                                </button>

                                                <AnimatePresence>
                                                    {isModeOpen && (
                                                        <motion.div
                                                            initial={{
                                                                opacity: 0,
                                                                scale: 0.96,
                                                                y: 8,
                                                                filter: "blur(4px)",
                                                            }}
                                                            animate={{
                                                                opacity: 1,
                                                                scale: 1,
                                                                y: 0,
                                                                filter: "blur(0px)",
                                                            }}
                                                            exit={{
                                                                opacity: 0,
                                                                scale: 0.96,
                                                                y: 8,
                                                                filter: "blur(4px)",
                                                            }}
                                                            transition={{
                                                                type: "spring",
                                                                stiffness: 400,
                                                                damping: 35,
                                                            }}
                                                            className="absolute bottom-full left-0 mb-3 w-64 p-2 bg-white/95 backdrop-blur-xl rounded-[20px] shadow-[0_20px_40px_-10px_rgba(0,0,0,0.15)] border border-white/60 flex flex-col gap-1 z-50 ring-1 ring-slate-900/5"
                                                        >
                                                            {[
                                                                {
                                                                    id: "pulse",
                                                                    label: "Pulso",
                                                                    icon: Zap,
                                                                    desc: "Respuesta instantánea",
                                                                },
                                                                {
                                                                    id: "compare",
                                                                    label: "Comparar",
                                                                    icon: Layers,
                                                                    desc: "Ejecución en paralelo",
                                                                },
                                                                {
                                                                    id: "fusion",
                                                                    label: "Fusión",
                                                                    icon: Scale,
                                                                    desc: "Consenso de 3 modelos",
                                                                },
                                                            ].map((m) => (
                                                                <button
                                                                    key={m.id}
                                                                    type="button"
                                                                    // eslint-disable-next-line @typescript-eslint/no-explicit-any
                                                                    onClick={() => {
                                                                        setIntelligenceMode(
                                                                            m.id as any,
                                                                        );
                                                                        setIsModeOpen(
                                                                            false,
                                                                        );
                                                                    }}
                                                                    className={clsx(
                                                                        "group relative flex items-start gap-3.5 p-3 rounded-2xl transition-all duration-200 text-left",
                                                                        intelligenceMode ===
                                                                            m.id
                                                                            ? "bg-blue-50/80"
                                                                            : "hover:bg-slate-50",
                                                                    )}
                                                                >
                                                                    <div
                                                                        className={clsx(
                                                                            "relative z-10 p-2 rounded-xl border shadow-[0_1px_2px_rgba(0,0,0,0.05)] transition-all duration-300 group-hover:scale-105 group-hover:shadow-md bg-white",
                                                                            intelligenceMode ===
                                                                                m.id
                                                                                ? "border-blue-100 text-blue-500 ring-2 ring-blue-50"
                                                                                : "border-slate-100 text-slate-400 group-hover:text-slate-600 group-hover:border-slate-200",
                                                                        )}
                                                                    >
                                                                        <m.icon className="w-4 h-4" />
                                                                    </div>
                                                                    <div className="relative z-10 flex flex-col pt-0.5">
                                                                        <span
                                                                            className={clsx(
                                                                                "text-[14px] font-bold tracking-tight font-display transition-colors",
                                                                                intelligenceMode ===
                                                                                    m.id
                                                                                    ? "text-blue-700"
                                                                                    : "text-slate-600 group-hover:text-slate-800",
                                                                            )}
                                                                        >
                                                                            {
                                                                                m.label
                                                                            }
                                                                        </span>
                                                                        <span className="text-[11px] text-slate-400 font-medium transition-all duration-300 opacity-60 group-hover:opacity-100 group-hover:translate-x-0.5">
                                                                            {
                                                                                m.desc
                                                                            }
                                                                        </span>
                                                                    </div>
                                                                    {intelligenceMode ===
                                                                        m.id && (
                                                                        <motion.div
                                                                            layoutId="activeCheck"
                                                                            className="absolute right-3 top-1/2 -translate-y-1/2 w-1.5 h-1.5 rounded-full bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.6)]"
                                                                        />
                                                                    )}
                                                                </button>
                                                            ))}
                                                        </motion.div>
                                                    )}
                                                </AnimatePresence>
                                            </div>
                                        </div>

                                        <button
                                            type="submit"
                                            disabled={
                                                !input.trim() && !attachment
                                            }
                                            className={`
                                    w-10 h-10 rounded-full flex items-center justify-center transition-all duration-300
                                    ${input.trim() || attachment ? "bg-[#007AFF] text-white hover:bg-blue-600 cursor-pointer shadow-md" : "bg-slate-100 text-slate-400 cursor-default"}
                                `}
                                        >
                                            <ArrowUp className="w-5 h-5" />
                                        </button>
                                    </div>
                                </div>
                                <div className="text-center mt-2">
                                    <p className="text-[11px] text-slate-400">
                                        BS Intelligence puede cometer errores.
                                        Considera verificar la información
                                        importante.
                                    </p>
                                </div>
                            </form>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
}
